#+TITLE: kons-9 多段展示实现计划
#+AUTHOR: Codex
#+DATE: 2026-01-29

* 参考来源与对齐目标
- 参考 kons-9 的 README：主流程以 REPL 交互与 demo 脚本驱动，强调可即时评估与可视化反馈
- 参考 kons-9 API 文档：基础类型（点/颜色/矩阵）、形状构造、形状分组、场景管理与命令表接口
- 本项目目标：保留热更新与 REPL 交互体验，并按讲座顺序输出多段可切换演示

* 阶段 0：需求锁定与约束
- 确认每段展示时长与切换方式：时间线自动切段 + REPL 手动跳段
- 目标分辨率与帧率（如 1280x720@60 / 1920x1080@60）
- 是否完全程序化（无外部纹理/模型/字体），以及是否需要文字叠加说明
- 允许的性能预算：CPU 生成网格上限、粒子数量上限、SDF 网格分辨率上限

* 阶段 1：基础重构（结构与生命周期）
- 拆模块：资源管理 / 场景状态 / 时间线 / 相机输入 / 热更新接口
- 统一生命周期：init -> update(dt) -> render -> cleanup
- 统一 GL 资源生命周期与释放策略（VAO/VBO/FBO/Program/Texture）
- 引入全局 state：时间、当前段、相机、可调参数、调试标志
- 对齐 kons-9 的 REPL 驱动体验：提供统一的热切换与热更新入口函数

* 阶段 2：基础数据与几何层（对齐 kons-9 API）
- 基础数据结构：点/点集、颜色、矩阵工具
- 形状构造：cube/sphere/cylinder/cone/point-cloud/polyhedron 的几何生成与缓存
- 形状分组：Group 节点与层级变换
- 最小交付物：在 REPL 内能创建/更新基础形体并立即渲染

* 阶段 3：多段展示框架
- Scene Registry：每段包含 init/update/render/cleanup
- 时间线驱动：以秒为单位推进，触发段落切换
- 过场机制：淡入淡出、镜头过渡、参数插值
- REPL 控制接口：set-scene! / set-param! / pause! / resume!
- 对齐 kons-9 的命令表思路：统一命令入口与可热替换的行为函数

* 阶段 4：基础几何与操作（讲座第 1 段）
- Mesh 生成器：立方体、球体（UV sphere/icosphere）、点云、分形立方体
- 参数热改：分形深度、点云数量、球体分段数
- Instancing 渲染用于点云与重复几何
- 基础材质：法线光照 + 纯色/渐变色

* 阶段 5：程序化动画与层级（讲座第 2 段）
- 动画模型：每个实体带 update-fn（函数式驱动）
- 层级变换：scene graph（父子节点变换）
- 关节示例（机器人臂）：多个节点相对旋转
- REPL 动态替换 update 函数

* 阶段 6：扫掠网格与 UV 变形（讲座第 3 段）
- 路径采样：正弦曲线或用户自定义点列
- 截面采样：圆/多边形，沿路径扫掠生成网格
- 生成 UV：路径方向作为 V，截面方向作为 U
- 变形：扭曲（twist）、锥化（taper）、波形（sin warp）

* 阶段 7：粒子系统与力场（讲座第 4 段）
- 粒子池：位置/速度/年龄/寿命/大小/颜色
- 发射器：点/圆环/多面体顶点/面中心
- 力场：重力、吸引子、噪声场（Perlin/Curl）
- 渲染方式：点精灵或 billboard quad，透明排序或近似分桶

* 阶段 8：SDF / Metaballs / Marching Cubes（讲座第 5 段）
- SDF 定义：球/盒/圆角盒，支持并/交/差组合
- Metaballs：基于势场叠加，生成等值面
- Marching Cubes：CPU 网格化，缓存网格并限制分辨率
- 可调参数：网格分辨率、阈值、平滑强度

* 阶段 9：动力学与弹簧质点（讲座第 6 段）
- 质点与弹簧结构：位置、速度、受力
- 积分：半隐式欧拉，支持阻尼
- 例子：蜘蛛网、软体块（晶格弹簧）
- 可视化：弹簧连线 + 质点球

* 阶段 10：生态模拟（讲座第 7 段）
- 代理系统：植物/食草动物/捕食者
- 能量系统：移动/觅食/死亡逻辑
- 低维视觉：球/盒/棱锥代表不同类型
- 规则参数化：速度、感知半径、出生/死亡阈值

* 阶段 11：后处理与表现力
- FBO 管线：场景渲染 -> 后处理 pass
- Bloom：亮度提取 + 高斯模糊 + 合成
- 色散/暗角/扫描线：在 post shader 内实现
- 统一色彩风格：色调映射与曝光控制

* 阶段 12：演示入口与说明
- 默认入口函数：自动播放多段演示
- REPL 控制指令：切段/暂停/参数调节
- 文档：运行方法、参数列表、性能建议

* 限制与未知（执行前确认）
- SDF/Marching Cubes 计算量与分辨率上限
- 粒子透明排序的性能与视觉权衡
- 后处理 pass 的性能开销
- Clojure GC 压力与 buffer 复用策略
- macOS OpenGL 版本限制
- 目标机器与分辨率/帧率
- 是否需要文字叠加与字体方案
